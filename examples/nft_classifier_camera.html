<html>
<body>
<div id="result">initializing</div>

<script>
var worker = new Worker('../js/artoolkit.worker.js');
worker.callID = 0;
worker.callbacks = {};
worker.listeners = {};

worker.call = function(id, method, arguments, transferables, callback) {
	var callID = this.callID++;
	if (typeof transferables === 'function') {
		callback = transferables;
		transferables = undefined;
	}
	this.callbacks[callID] = callback;
	this.postMessage({
		method: method,
		id: id,
		callID: callID,
		arguments: arguments
	}, transferables);
};

worker.addEventListener = function(name, callback) {
	if (!this.listeners[name]) {
		this.listeners[name] = [];
	}
	this.listeners[name].push(callback);
};

worker.removeEventListener = function(name, callback) {
	if (this.listeners[name]) {
		var index = this.listeners[name].indexOf(callback);
		if (index > -1) {
			this.listeners[name].splice(index, 1);
		}
	}
};

worker.dispatchEvent = function(event) {
	var listeners = this.listeners[event.name];
	if (listeners) {
		for (var i=0; i<listeners.length; i++) {
			listeners[i].call(this, event);
		}
	}
};

worker.onmessage = function(ev) {
	if (ev.data.event) {
		this.dispatchEvent(ev.data.event);
	} else {
		var callback = this.callbacks[ev.data.callID];
		if (callback) {
			callback(ev.data);
		}
		delete this.callbacks[ev.data.callID];
	}
};



var video = document.createElement('video');
// for safari ios
video.setAttribute("playsinline", true);
video.setAttribute("autoplay", true);

document.body.appendChild(video);


navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

// ios safari cannot use userMedia if width=320(overconstraint error)
// http://lealog.hateblo.jp/entry/2017/08/21/155211
// mac w=320  ios w=640
const isIOS = /iP(hone|(o|a)d)/.test(navigator.userAgent)
console.log('os check', isIOS);
if(isIOS) {
  var tw = 640;
  var th = 480;
}else {
  var tw = 320;
  var th = 240;
}

// mediaDevices.getUserMediaが使えないときはfacingMode: "environment" は入れられない
var hdConstraints = {
	audio: false,
	video: {
		mandatory: {
			maxWidth: tw,
			maxHeight: th
    	}
  	}
};

if (navigator.mediaDevices.getUserMedia) {
  console.log('have mediaDevices.getUserMedia');
  navigator.mediaDevices.getUserMedia({
    audio: false,
    video: {
      width: {max: tw},
      height: {max: th},
      facingMode: "environment"
    }
  }).then(success, errorCallback);
} else if(navigator.getUserMedia) {
  console.log('only have getUserMedia');
	navigator.getUserMedia(hdConstraints, success, errorCallback);
} else {
	errorCallback('');
}

function errorCallback(e) {
	console.log("Can't access user media", e);
}


function success(stream) {
	console.log('success', stream);
  console.log('a', stream.getVideoTracks()[0]);
  console.log('a', stream.getVideoTracks()[0].getSettings());
	// video.src = window.URL.createObjectURL(stream); // depricated
  video.srcObject = stream;
	video.onclick = function() { video.play(); };
	video.play();

  var cw = 320;
  var ch = 240;
	var canvas = document.createElement('canvas');
	canvas.width = cw;
	canvas.height = ch;
	var ctx = canvas.getContext('2d');

	worker.call(null, 'new', [cw, ch, '/examples/Data/camera_para.dat']);
	worker.addEventListener('load', function(ev) {
		var id = ev.target;
		console.log('ARController loaded', ev);

    var packagefile = {filename: '/examples/Pattern/catted.data',
      targets: ["1.fset", "1.fset3", "1.iset", "2.fset", "2.fset3", "2.iset"],
      sizes: [704, 101248, 9562, 6912, 507316, 49742]};

		worker.call(id, 'loadNFTMarker', ['/examples/DataNFT/pinball'], function(ev) {
			console.log('Created NFT marker', ev);

			worker.addEventListener('getNFTMarker', function(ev) {
				console.log("Found NFT marker", ev);
			});

			var processingDone = true;
			var tick = function() {
				if (video.videoWidth && processingDone) {
          console.log('video width', video.videoWidth, video.videoHeight, cw, ch);
          // https://webrtc.github.io/samples/src/content/getusermedia/resolution/
					processingDone = false;
          var imageData;

          if (video.videoWidth >= video.videoHeight) {
            // 横向きの画像だったら、そのまま貼ればOK
            console.log('original');
            ctx.drawImage(video, 0, 0, cw, ch);
            imageData = ctx.getImageData(0,0,cw,ch);
          } else {
            console.log('rotated');
            // 縦向きの画像だったら、回転してctxに貼る
            ctx.rotate(Math.PI/2);
            ctx.drawImage(video, 0, 0-cw, ch, cw);
            imageData = ctx.getImageData(0,0,cw,ch);
          }
					worker.call(id, 'process', [imageData], [imageData.data.buffer], function(ev) {
						console.log('Processed frame');
						processingDone = true;
					});
				}
				requestAnimationFrame(tick);
			};
			tick();
		});
/*
    worker.call(id, 'loadNFTMarkerPackage', [packagefile], function(ev) {
      if(ev.result[0] === 'final') {
        console.log('Created NFT marker', ev);
        document.getElementById('result').textContent = 'start!';

        worker.addEventListener('getNFTMarker', function(ev) {
          console.log("Found NFT marker", ev);
          document.getElementById('result').textContent = 'found ' + ev.data.marker.id;
          setTimeout(function() {
            document.getElementById('result').textContent = 'searching';
          }, 1000);
        });

        var processingDone = true;
        var tick = function() {
          if (video.videoWidth && processingDone) {
            processingDone = false;
            ctx.drawImage(video, 0, 0, 640, 480);
            var imageData = ctx.getImageData(0,0,640,480);
            worker.call(id,'process',[imageData],[imageData.data.buffer],function(ev) {
              console.log('Processed frame');
              processingDone = true;
            });
          }
          requestAnimationFrame(tick);
        };
        tick();
        // マーカーロード終了
        //document.getElementById('result').textContent = 'start!';
      }
    }); */
	});
}


</script>

</body>
</html>
